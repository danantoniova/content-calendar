// Google Apps Script Code for Content Calendar Integration
// Copy this code into Google Apps Script (script.google.com)

function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);
    const action = data.action;
    const spreadsheetId = data.spreadsheetId;
    
    if (!spreadsheetId) {
      return ContentService
        .createTextOutput(JSON.stringify({ error: 'Spreadsheet ID required' }))
        .setMimeType(ContentService.MimeType.JSON);
    }
    
    switch(action) {
      case 'save':
        return saveCalendarData(spreadsheetId, data.calendarData);
      case 'load':
        return loadCalendarData(spreadsheetId, data.weekStart);
      default:
        throw new Error('Invalid action');
    }
  } catch(error) {
    return ContentService
      .createTextOutput(JSON.stringify({ error: error.toString() }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

function doGet(e) {
  // Handle GET requests for testing
  const action = e.parameter.action;
  const spreadsheetId = e.parameter.spreadsheetId;
  
  if (action === 'test') {
    return ContentService
      .createTextOutput(JSON.stringify({ status: 'Google Apps Script is working!' }))
      .setMimeType(ContentService.MimeType.JSON);
  }
  
  return ContentService
    .createTextOutput(JSON.stringify({ error: 'Use POST for calendar operations' }))
    .setMimeType(ContentService.MimeType.JSON);
}

function saveCalendarData(spreadsheetId, calendarData) {
  try {
    const ss = SpreadsheetApp.openById(spreadsheetId);
    let sheet = ss.getSheetByName('Content Calendar');
    
    // Create sheet if it doesn't exist
    if (!sheet) {
      sheet = ss.insertSheet('Content Calendar');
      // Add headers
      sheet.getRange(1, 1, 1, 4).setValues([['Date', 'Day', 'Section', 'Content']]);
      sheet.getRange(1, 1, 1, 4).setFontWeight('bold');
      sheet.setFrozenRows(1);
    }
    
    // Clear existing data (keep headers)
    const lastRow = sheet.getLastRow();
    if (lastRow > 1) {
      sheet.getRange(2, 1, lastRow - 1, 4).clearContent();
    }
    
    // Prepare data for insertion
    const rows = [];
    const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    
    Object.keys(calendarData).forEach(dateKey => {
      const date = new Date(dateKey);
      const dayName = dayNames[date.getDay()];
      const formattedDate = Utilities.formatDate(date, Session.getScriptTimeZone(), 'MM/dd/yyyy');
      
      calendarData[dateKey].forEach(item => {
        rows.push([formattedDate, dayName, item.section, item.content]);
      });
    });
    
    // Insert data if there are rows
    if (rows.length > 0) {
      sheet.getRange(2, 1, rows.length, 4).setValues(rows);
      
      // Auto-resize columns
      sheet.autoResizeColumns(1, 4);
      
      // Add some formatting
      sheet.getRange(2, 1, rows.length, 1).setNumberFormat('mm/dd/yyyy');
      sheet.getRange(1, 1, rows.length + 1, 4).setBorder(true, true, true, true, true, true);
    }
    
    return ContentService
      .createTextOutput(JSON.stringify({ 
        success: true, 
        message: `Saved ${rows.length} entries to Google Sheets`,
        rowsSaved: rows.length
      }))
      .setMimeType(ContentService.MimeType.JSON);
      
  } catch(error) {
    return ContentService
      .createTextOutput(JSON.stringify({ 
        error: 'Failed to save: ' + error.toString() 
      }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

function loadCalendarData(spreadsheetId, weekStart) {
  try {
    const ss = SpreadsheetApp.openById(spreadsheetId);
    const sheet = ss.getSheetByName('Content Calendar');
    
    if (!sheet) {
      return ContentService
        .createTextOutput(JSON.stringify({ 
          success: true, 
          data: {},
          message: 'No calendar sheet found - create one by saving first'
        }))
        .setMimeType(ContentService.MimeType.JSON);
    }
    
    const lastRow = sheet.getLastRow();
    if (lastRow <= 1) {
      return ContentService
        .createTextOutput(JSON.stringify({ 
          success: true, 
          data: {},
          message: 'No calendar data found'
        }))
        .setMimeType(ContentService.MimeType.JSON);
    }
    
    // Get all data
    const range = sheet.getRange(2, 1, lastRow - 1, 4);
    const values = range.getValues();
    
    // Calculate week range
    const startDate = new Date(weekStart);
    const endDate = new Date(startDate);
    endDate.setDate(startDate.getDate() + 6);
    
    // Filter data for the requested week
    const weekData = {};
    values.forEach(row => {
      const [date, day, section, content] = row;
      const rowDate = new Date(date);
      
      if (rowDate >= startDate && rowDate <= endDate) {
        const dateKey = Utilities.formatDate(rowDate, Session.getScriptTimeZone(), 'yyyy-MM-dd');
        
        if (!weekData[dateKey]) {
          weekData[dateKey] = [];
        }
        
        weekData[dateKey].push({
          section: section,
          content: content
        });
      }
    });
    
    return ContentService
      .createTextOutput(JSON.stringify({ 
        success: true, 
        data: weekData,
        message: `Loaded data for week starting ${Utilities.formatDate(startDate, Session.getScriptTimeZone(), 'MM/dd/yyyy')}`
      }))
      .setMimeType(ContentService.MimeType.JSON);
      
  } catch(error) {
    return ContentService
      .createTextOutput(JSON.stringify({ 
        error: 'Failed to load: ' + error.toString() 
      }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

// Helper function to set up the spreadsheet structure
function setupCalendarSpreadsheet(spreadsheetId) {
  try {
    const ss = SpreadsheetApp.openById(spreadsheetId);
    let sheet = ss.getSheetByName('Content Calendar');
    
    if (!sheet) {
      sheet = ss.insertSheet('Content Calendar');
    }
    
    // Set up headers and formatting
    const headers = ['Date', 'Day', 'Section', 'Content'];
    sheet.getRange(1, 1, 1, 4).setValues([headers]);
    sheet.getRange(1, 1, 1, 4).setFontWeight('bold');
    sheet.setFrozenRows(1);
    sheet.autoResizeColumns(1, 4);
    
    // Set column widths for better display
    sheet.setColumnWidth(1, 100); // Date
    sheet.setColumnWidth(2, 100); // Day
    sheet.setColumnWidth(3, 150); // Section
    sheet.setColumnWidth(4, 400); // Content
    
    return { success: true, message: 'Spreadsheet setup complete' };
  } catch(error) {
    return { error: 'Setup failed: ' + error.toString() };
  }
}
